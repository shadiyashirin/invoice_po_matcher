# render.yaml
# The complete and correct blueprint for deploying the Django application on Render.

services:
  # =============================
  #  1. The PostgreSQL Database Service (This was missing)
  # =============================
  - type: psql
    name: invoice-matcher-db
    databaseName: invoice_matcher_db
    user: invoice_matcher_user
    plan: free

  # =============================
  #  2. The Django Web Service
  # =============================
  - type: web
    name: invoice-matcher-app
    runtime: python
    plan: free
    # CRITICAL: Installs Tesseract on the server (This was missing)
    buildPacks:
      - url: https://github.com/heroku/heroku-buildpack-python
      - url: https://github.com/pathwaysmedical/heroku-buildpack-tesseract
    # UPDATED: Includes the 'migrate' command
    buildCommand: "pip install -r requirements.txt && python manage.py collectstatic --noinput && python manage.py migrate"
    startCommand: "gunicorn invoice_po_matcher.wsgi:application"
    envVars:
      - key: PYTHON_VERSION
        value: 3.11.4
      # This now correctly links to the database service defined above
      - key: DATABASE_URL
        fromDatabase:
          name: invoice-matcher-db
          property: internalUrl
      - key: SECRET_KEY
        generateValue: true
      - key: GOOGLE_API_KEY
        sync: false


